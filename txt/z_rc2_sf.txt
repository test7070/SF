z_rc2_sf1:--z_rc2_sf1
SET QUOTED_IDENTIFIER OFF
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_btggno nvarchar(20) 
declare @t_etggno nvarchar(20) 
declare @rc2typea nvarchar(10)
declare @t_product nvarchar(max)
declare @t_spec nvarchar(30)
declare @t_size nvarchar(10)
declare @t_class nvarchar(10)
declare @t_blengthb float
declare @t_elengthb float 
declare @t_qno nvarchar(50)
declare @t_bstoreno nvarchar(20) 
declare @t_estoreno nvarchar(20)
declare @qhref_acomp nvarchar(10) ='' 
declare @t_check nvarchar(1)
declare @t_bxdate nvarchar(20)
declare @t_exdate nvarchar(20)
declare @t_noshowina nvarchar(20)
 
set @t_bdate = case when '#non'=[4] then '' else [4] end 
set @t_edate = case when '#non'=[5] then char(255) else [5] end 
set @t_btggno = case when '#non'=[8] then '' else [8] end 
set @t_etggno = case when '#non'=[9] then char(255) else [9]  end
set @rc2typea = case when '#non' = [10] then '' else [10] end  
set @t_product = case when '#non'=[11] then '' else [11] end
set @t_spec = case when '#non'=[12] then '' else [12] end
set @t_size = case when '#non'=[13] then '' else [13] end
set @t_class = case when '#non'=[14] then '' else [14] end
set @t_check = case when '#non'=[15] then '' else [15] end
set @t_blengthb = case when '#non'=[16] then 0 else [16] end
set @t_elengthb = case when '#non'=[17] then 99 else [17] end
set @t_qno = case when '#non'=[18] then '' else [18] end
set @t_bstoreno = case when '#non'=[19] then '' else [19] end 
set @t_estoreno = case when '#non'=[20] then char(255) else [20]  end
set @t_bxdate = case when '#non'=[22] then '' else [22] end 
set @t_exdate = case when '#non'=[23] then char(255) else [23] end
set @t_noshowina = case when '#non'=[24] then '' else [24] end  
 
declare @tmp table(
	gno nvarchar(1),
	rr int,
	datea nvarchar(10),
	noa nvarchar(50),
	tggno nvarchar(50),
	nick nvarchar(100),
	ordeno nvarchar(100),
	tranmoney float,
	noq nvarchar(50),
	productno nvarchar(50),
	product nvarchar(max),
	mount float,
	price float,
	total float,
	tmount float,
	ttotal float,
	ghref nvarchar(max),
	memo nvarchar(max)
)

if(@t_noshowina='1')
begin
	insert @tmp
	select '9','',a.datea,a.noa,a.tggno,c.nick
	,SUBSTRING(a.transtart,0,CHARINDEX('@',a.transtart)),tranmoney
	,ROW_NUMBER()over(partition by a.noa order by a.noa),productno
	,case when isnull(ucolor,'')!='' then ucolor+' ' else '' end+case when isnull(spec,'')!='' then spec+' ' else '' end+product+size+case when isnull(lengthb,0)!=0 then ' '+cast(lengthb as nvarchar(20))+'M' else '' end
	,b.mount,b.price,b.total,case when product='鋼筋' then b.mount else 0 end,b.total
	,'rc2_sf?noa=$noa?'+a.accy,a.memo
	from view_rc2 a left join view_rc2s b on a.noa=b.noa 
	left join tgg c on a.tggno=c.noa 
	where (a.datea between case when @t_bxdate<@t_bdate then @t_bxdate else @t_bdate end and case when @t_edate>@t_exdate then @t_edate else @t_exdate end) and 
	(a.tggno between @t_btggno and @t_etggno)  and
	(isnull(b.storeno,'') between @t_bstoreno and @t_estoreno) and
	(len(@rc2typea)=0 or @rc2typea=a.typea) and
	(len(@t_product)=0 or @t_product=b.product)and
	(len(@t_spec)=0 or @t_spec=b.spec) and
	(len(@t_size)=0 or @t_size=b.size) and
	(len(@t_class)=0 or @t_class=b.class) and
	(isnull(b.lengthb,0) between @t_blengthb and @t_elengthb) and 
	(len(@t_qno)=0 or dbo.split(dbo.split(a.transtart,'##',0),'@',0) = @t_qno or dbo.split(dbo.split(a.transtart,'##',1),'@',0) = @t_qno)
	and not exists(select noa from view_ina where noa=a.noa)
end
else
begin
	insert @tmp
	select '9','',a.datea,a.noa,a.tggno,c.nick
	,SUBSTRING(a.transtart,0,CHARINDEX('@',a.transtart)),tranmoney
	,ROW_NUMBER()over(partition by a.noa order by a.noa),productno
	,case when isnull(ucolor,'')!='' then ucolor+' ' else '' end+case when isnull(spec,'')!='' then spec+' ' else '' end+product+size+case when isnull(lengthb,0)!=0 then ' '+cast(lengthb as nvarchar(20))+'M' else '' end
	,b.mount,b.price,b.total,case when product='鋼筋' then b.mount else 0 end,b.total
	,'rc2_sf?noa=$noa?'+a.accy,a.memo
	from view_rc2 a left join view_rc2s b on a.noa=b.noa 
	left join tgg c on a.tggno=c.noa 
	where (a.datea between case when @t_bxdate<@t_bdate then @t_bxdate else @t_bdate end and case when @t_edate>@t_exdate then @t_edate else @t_exdate end) and 
	(a.tggno between @t_btggno and @t_etggno)  and
	(isnull(b.storeno,'') between @t_bstoreno and @t_estoreno) and
	(len(@rc2typea)=0 or @rc2typea=a.typea) and
	(len(@t_product)=0 or @t_product=b.product)and
	(len(@t_spec)=0 or @t_spec=b.spec) and
	(len(@t_size)=0 or @t_size=b.size) and
	(len(@t_class)=0 or @t_class=b.class) and
	(isnull(b.lengthb,0) between @t_blengthb and @t_elengthb) and 
	(len(@t_qno)=0 or dbo.split(dbo.split(a.transtart,'##',0),'@',0) = @t_qno or dbo.split(dbo.split(a.transtart,'##',1),'@',0) = @t_qno)
end

insert @tmp
select case when noq='1' then 1 else 2 end ,'',datea,noa,tggno,nick,ordeno
,tranmoney,noq,productno,product,mount,price,total,tmount,ttotal,ghref,memo
from @tmp
where datea between @t_bdate and @t_edate
	  
update a
set rr=rx
from (select ROW_NUMBER()over(partition by gno order by noa)rx,rr from @tmp where gno='1')a

insert @tmp(gno,noa,tranmoney,tmount,ttotal)
select '8',noa,tranmoney,SUM(tmount),sum(total)
from @tmp
where gno='1' or gno='2'
group by noa,tranmoney

update @tmp
set tmount=b.tmount,ttotal=b.ttotal
from @tmp a 
outer apply(select tmount,ttotal from @tmp where gno='8' and noa=a.noa)b

insert @tmp(gno,noa,tranmoney,tmount,ttotal)
select '7',noa,tranmoney,SUM(tmount),sum(total)
from @tmp
where gno='9'
and(datea between @t_bxdate and @t_exdate)
group by noa,tranmoney

insert @tmp(gno,noa,tranmoney,tmount,ttotal)
select '3',CHAR(255),sum(tranmoney),SUM(tmount),sum(ttotal)
from @tmp
where gno='8'

insert @tmp(gno,noa,tranmoney,tmount,ttotal)
select '4',CHAR(255),sum(tranmoney),SUM(tmount),sum(ttotal)
from @tmp
where gno='7'

delete @tmp where gno='9' or gno='8' or gno='7'  
	  
select 
@t_bxdate bxdate,@t_exdate exdate
,dbo.getComma(total,0) total
,dbo.getComma(ttotal,0) ttotal
,dbo.getComma(price,3) price
,dbo.getComma(mount,0) mount
,dbo.getComma(tranmoney,0) tranmoney
,* from @tmp order by noa,gno
;
------------------------------------------------------------------------------------------------------------------------
z_rc2_sf2:--z_rc2_sf2 
SET QUOTED_IDENTIFIER OFF
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_btggno nvarchar(20) 
declare @t_etggno nvarchar(20) 
declare @rc2typea nvarchar(10)
declare @t_product nvarchar(max)
declare @t_spec nvarchar(30)
declare @t_size nvarchar(10)
declare @t_class nvarchar(10)
declare @t_blengthb float
declare @t_elengthb float 
declare @t_qno nvarchar(50)
declare @t_bstoreno nvarchar(20) 
declare @t_estoreno nvarchar(20)
declare @qhref_acomp nvarchar(10) ='' 
declare @t_check nvarchar(1)
declare @t_bxdate nvarchar(20)
declare @t_exdate nvarchar(20)
declare @t_noshowina nvarchar(20)
 
set @t_bdate = case when '#non'=[4] then '' else [4] end 
set @t_edate = case when '#non'=[5] then char(255) else [5] end 
set @t_btggno = case when '#non'=[8] then '' else [8] end 
set @t_etggno = case when '#non'=[9] then char(255) else [9]  end
set @rc2typea = case when '#non' = [10] then '' else [10] end  
set @t_product = case when '#non'=[11] then '' else [11] end
set @t_spec = case when '#non'=[12] then '' else [12] end
set @t_size = case when '#non'=[13] then '' else [13] end
set @t_class = case when '#non'=[14] then '' else [14] end
set @t_check = case when '#non'=[15] then '' else [15] end
set @t_blengthb = case when '#non'=[16] then 0 else [16] end
set @t_elengthb = case when '#non'=[17] then 99 else [17] end
set @t_qno = case when '#non'=[18] then '' else [18] end
set @t_bstoreno = case when '#non'=[19] then '' else [19] end 
set @t_estoreno = case when '#non'=[20] then char(255) else [20]  end
set @t_bxdate = case when '#non'=[22] then '' else [22] end 
set @t_exdate = case when '#non'=[23] then char(255) else [23] end
set @t_noshowina = case when '#non'=[24] then '' else [24] end  
 
declare @tmp table(
	gno nvarchar(1),
	rr int,
	datea nvarchar(10),
	noa nvarchar(50),
	tggno nvarchar(50),
	nick nvarchar(100),
	ordeno nvarchar(100),
	transtyle nvarchar(50),
	tranmoney float,
	noq nvarchar(50),
	productno nvarchar(50),
	product nvarchar(max),
	mount float,
	price float,
	total float,
	tmount float,
	ttotal float,
	ghref nvarchar(max),
	carno nvarchar(50)
)
if(@t_noshowina='1')
begin
	insert @tmp
	select '9','',a.datea,a.noa,a.tggno,c.nick
	,SUBSTRING(a.transtart,0,CHARINDEX('@',a.transtart))
	,case when ISNULL(tranmoney,0)!=0 then '含運' else '自運' end,tranmoney
	,ROW_NUMBER()over(partition by a.noa order by a.noa),productno
	,case when isnull(ucolor,'')!='' then ucolor+' ' else '' end+case when isnull(spec,'')!='' then spec+' ' else '' end+product+size+case when isnull(lengthb,0)!=0 then ' '+cast(lengthb as nvarchar(20))+'M' else '' end
	,b.mount,b.price,b.total,case when product='鋼筋' then b.mount else 0 end,b.total
	,'rc2_sf?noa=$noa?'+a.accy,a.carno
	from view_rc2 a left join view_rc2s b on a.noa=b.noa 
	left join tgg c on a.tggno=c.noa 
	where (a.datea between case when @t_bxdate<@t_bdate then @t_bxdate else @t_bdate end and case when @t_edate>@t_exdate then @t_edate else @t_exdate end) and 
	(a.tggno between @t_btggno and @t_etggno)  and
	(isnull(b.storeno,'') between @t_bstoreno and @t_estoreno) and
	(len(@rc2typea)=0 or @rc2typea=a.typea) and
	(len(@t_product)=0 or @t_product=b.product)and
	(len(@t_spec)=0 or @t_spec=b.spec) and
	(len(@t_size)=0 or @t_size=b.size) and
	(len(@t_class)=0 or @t_class=b.class) and
	(isnull(b.lengthb,0) between @t_blengthb and @t_elengthb) and 
	(len(@t_qno)=0 or dbo.split(dbo.split(a.transtart,'##',0),'@',0) = @t_qno or dbo.split(dbo.split(a.transtart,'##',1),'@',0) = @t_qno)
	and not exists(select noa from view_ina where noa=a.noa)
end
else
begin
	insert @tmp
	select '9','',a.datea,a.noa,a.tggno,c.nick
	,SUBSTRING(a.transtart,0,CHARINDEX('@',a.transtart))
	,case when ISNULL(tranmoney,0)!=0 then '含運' else '自運' end,tranmoney
	,ROW_NUMBER()over(partition by a.noa order by a.noa),productno
	,case when isnull(ucolor,'')!='' then ucolor+' ' else '' end+case when isnull(spec,'')!='' then spec+' ' else '' end+product+size+case when isnull(lengthb,0)!=0 then ' '+cast(lengthb as nvarchar(20))+'M' else '' end
	,b.mount,b.price,b.total,case when product='鋼筋' then b.mount else 0 end,b.total
	,'rc2_sf?noa=$noa?'+a.accy,a.carno
	from view_rc2 a left join view_rc2s b on a.noa=b.noa 
	left join tgg c on a.tggno=c.noa 
	where (a.datea between case when @t_bxdate<@t_bdate then @t_bxdate else @t_bdate end and case when @t_edate>@t_exdate then @t_edate else @t_exdate end) and 
	(a.tggno between @t_btggno and @t_etggno)  and
	(isnull(b.storeno,'') between @t_bstoreno and @t_estoreno) and
	(len(@rc2typea)=0 or @rc2typea=a.typea) and
	(len(@t_product)=0 or @t_product=b.product)and
	(len(@t_spec)=0 or @t_spec=b.spec) and
	(len(@t_size)=0 or @t_size=b.size) and
	(len(@t_class)=0 or @t_class=b.class) and
	(isnull(b.lengthb,0) between @t_blengthb and @t_elengthb) and 
	(len(@t_qno)=0 or dbo.split(dbo.split(a.transtart,'##',0),'@',0) = @t_qno or dbo.split(dbo.split(a.transtart,'##',1),'@',0) = @t_qno)
end

insert @tmp
select case when noq='1' then 1 else 2 end ,'',datea,noa,tggno,nick,ordeno,transtyle
,tranmoney,noq,productno,product,mount,price,total,tmount,ttotal,ghref,carno
from @tmp
where datea between @t_bdate and @t_edate
	  
update a
set rr=rx
from (select ROW_NUMBER()over(partition by gno order by noa)rx,rr from @tmp where gno='1')a

insert @tmp(gno,noa,tranmoney,tmount,ttotal)
select '8',noa,tranmoney,SUM(tmount),sum(total)
from @tmp
where gno='1' or gno='2'
group by noa,tranmoney

update @tmp
set tmount=b.tmount,ttotal=b.ttotal
from @tmp a 
outer apply(select tmount,ttotal from @tmp where gno='8' and noa=a.noa)b

insert @tmp(gno,noa,tranmoney,tmount,ttotal)
select '7',noa,tranmoney,SUM(tmount),sum(total)
from @tmp
where gno='9'
and(datea between @t_bxdate and @t_exdate)
group by noa,tranmoney

insert @tmp(gno,noa,tranmoney,tmount,ttotal)
select '3',CHAR(255),sum(tranmoney),SUM(tmount),sum(ttotal)
from @tmp
where gno='8'

insert @tmp(gno,noa,tranmoney,tmount,ttotal)
select '4',CHAR(255),sum(tranmoney),SUM(tmount),sum(ttotal)
from @tmp
where gno='7'

delete @tmp where gno='9' or gno='8' or gno='7'  
	  
select 
@t_bxdate bxdate,@t_exdate exdate
,dbo.getComma(total,0) total
,dbo.getComma(ttotal,0) ttotal
,dbo.getComma(price,3) price
,dbo.getComma(mount,0) mount
,dbo.getComma(tranmoney,0) tranmoney
,* from @tmp order by noa,gno
;
------------------------------------------------------------------------------------------------------------
z_rc2_sf3:--z_rc2_sf3
SET QUOTED_IDENTIFIER OFF
declare @t_bdate nvarchar(20)
declare @t_edate nvarchar(20)
declare @t_btggno nvarchar(20) 
declare @t_etggno nvarchar(20) 
declare @rc2typea nvarchar(10)
declare @t_product nvarchar(max)
declare @t_spec nvarchar(30)
declare @t_size nvarchar(10)
declare @t_class nvarchar(10)
declare @t_blengthb float
declare @t_elengthb float 
declare @t_qno nvarchar(50)
declare @t_bstoreno nvarchar(20) 
declare @t_estoreno nvarchar(20)
declare @qhref_acomp nvarchar(10) ='' 
declare @t_check nvarchar(1)
declare @t_bxdate nvarchar(20)
declare @t_exdate nvarchar(20)
declare @t_noshowina nvarchar(20)
 
set @t_bdate = case when '#non'=[4] then '' else [4] end 
set @t_edate = case when '#non'=[5] then char(255) else [5] end 
set @t_btggno = case when '#non'=[8] then '' else [8] end 
set @t_etggno = case when '#non'=[9] then char(255) else [9]  end
set @rc2typea = case when '#non' = [10] then '' else [10] end  
set @t_product = case when '#non'=[11] then '' else [11] end
set @t_spec = case when '#non'=[12] then '' else [12] end
set @t_size = case when '#non'=[13] then '' else [13] end
set @t_class = case when '#non'=[14] then '' else [14] end
set @t_check = case when '#non'=[15] then '' else [15] end
set @t_blengthb = case when '#non'=[16] then 0 else [16] end
set @t_elengthb = case when '#non'=[17] then 99 else [17] end
set @t_qno = case when '#non'=[18] then '' else [18] end
set @t_bstoreno = case when '#non'=[19] then '' else [19] end 
set @t_estoreno = case when '#non'=[20] then char(255) else [20]  end
set @t_bxdate = case when '#non'=[22] then '' else [22] end 
set @t_exdate = case when '#non'=[23] then char(255) else [23] end
set @t_noshowina = case when '#non'=[24] then '' else [24] end  
 
declare @tmp table(
	gno nvarchar(1),
	rr int,
	datea nvarchar(10),
	noa nvarchar(50),
	tggno nvarchar(50),
	comp nvarchar(100),
	ordeno nvarchar(100),
	tax float,
	tranmoney float,
	noq nvarchar(50),
	productno nvarchar(50),
	product nvarchar(max),
	mount float,
	price float,
	total float,
	tmount float,
	ttotal float,
	money float,
	ghref nvarchar(max),
	memo nvarchar(max)
)
if(@t_noshowina='1')
begin
	insert @tmp
	select '9','',a.datea,a.noa,a.tggno,a.tgg
	,SUBSTRING(a.transtart,0,CHARINDEX('@',a.transtart)),tax,tranmoney
	,ROW_NUMBER()over(partition by a.noa order by a.noa)
	,productno
	,case when isnull(ucolor,'')!='' then ucolor+' ' else '' end+case when isnull(spec,'')!='' then spec+' ' else '' end+product+size+case when isnull(lengthb,0)!=0 then ' '+cast(lengthb as nvarchar(20))+'M' else '' end
	,b.mount,b.price,b.total,case when product='鋼筋' then b.mount else 0 end,b.total,0
	,'rc2_sf?noa=$noa?'+a.accy,a.memo
	from view_rc2 a left join view_rc2s b on a.noa=b.noa 
	where (a.datea between @t_bdate and @t_edate) and 
	(a.tggno between @t_btggno and @t_etggno)  and
	(isnull(b.storeno,'') between @t_bstoreno and @t_estoreno) and
	(len(@rc2typea)=0 or @rc2typea=a.typea) and
	(len(@t_product)=0 or @t_product=b.product)and
	(len(@t_spec)=0 or @t_spec=b.spec) and
	(len(@t_size)=0 or @t_size=b.size) and
	(len(@t_class)=0 or @t_class=b.class) and
	(isnull(b.lengthb,0) between @t_blengthb and @t_elengthb) and 
	(len(@t_qno)=0 or dbo.split(dbo.split(a.transtart,'##',0),'@',0) = @t_qno or dbo.split(dbo.split(a.transtart,'##',1),'@',0) = @t_qno)
	and not exists (select noa from view_ina where noa=a.noa)
end
else
begin		
	insert @tmp
	select '9','',a.datea,a.noa,a.tggno,a.tgg
	,SUBSTRING(a.transtart,0,CHARINDEX('@',a.transtart)),tax,tranmoney
	,ROW_NUMBER()over(partition by a.noa order by a.noa)
	,productno
	,case when isnull(ucolor,'')!='' then ucolor+' ' else '' end+case when isnull(spec,'')!='' then spec+' ' else '' end+product+size+case when isnull(lengthb,0)!=0 then ' '+cast(lengthb as nvarchar(20))+'M' else '' end
	,b.mount,b.price,b.total,case when product='鋼筋' then b.mount else 0 end,b.total,0
	,'rc2_sf?noa=$noa?'+a.accy,a.memo
	from view_rc2 a left join view_rc2s b on a.noa=b.noa 
	where (a.datea between @t_bdate and @t_edate) and 
	(a.tggno between @t_btggno and @t_etggno)  and
	(isnull(b.storeno,'') between @t_bstoreno and @t_estoreno) and
	(len(@rc2typea)=0 or @rc2typea=a.typea) and
	(len(@t_product)=0 or @t_product=b.product)and
	(len(@t_spec)=0 or @t_spec=b.spec) and
	(len(@t_size)=0 or @t_size=b.size) and
	(len(@t_class)=0 or @t_class=b.class) and
	(isnull(b.lengthb,0) between @t_blengthb and @t_elengthb) and 
	(len(@t_qno)=0 or dbo.split(dbo.split(a.transtart,'##',0),'@',0) = @t_qno or dbo.split(dbo.split(a.transtart,'##',1),'@',0) = @t_qno)
end

insert @tmp
select case when noq='1' then 1 else 2 end ,'',datea,noa,tggno,comp,ordeno
,tax,tranmoney,noq,productno,product,mount,price,total,tmount,ttotal,0,ghref,memo
from @tmp

update a
set rr=rx
from (select ROW_NUMBER()over(partition by gno,tggno order by noa)rx,rr from @tmp where gno='1')a

insert @tmp(gno,tggno,ordeno,noa,tranmoney,tax,tmount,ttotal,money)
select '8',tggno,ordeno,noa,tranmoney,tax,SUM(tmount),sum(total),tranmoney+tax+sum(total)
from @tmp
where (gno='1' or gno='2')
group by noa,tggno,ordeno,tranmoney,tax

update @tmp
set tmount=b.tmount,ttotal=b.ttotal,money=b.money
from @tmp a 
outer apply(select tmount,ttotal,money from @tmp where gno='8' and noa=a.noa)b

insert @tmp(gno,tggno,ordeno,noa,tranmoney,tmount,ttotal,money)
select '3',tggno,ordeno,CHAR(255),sum(tranmoney),SUM(tmount),sum(ttotal),sum(money)
from @tmp
where gno='8'
group by tggno,ordeno

delete @tmp where gno='9' or gno='8' 

insert @tmp(gno,tggno,ordeno,noa)
select '4',tggno,ordeno,CHAR(255)
from @tmp 
group by tggno,ordeno
	  
select 
dbo.getComma(total,0) total
,dbo.getComma(ttotal,0) ttotal
,dbo.getComma(price,3) price
,dbo.getComma(mount,0) mount
,dbo.getComma(tranmoney,0) tranmoney
,* from @tmp order by tggno,ordeno,noa,gno
;